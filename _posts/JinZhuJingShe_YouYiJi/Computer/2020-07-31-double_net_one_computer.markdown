---
layout:     post
title:      "双网卡电脑同时上内外网"
subtitle:   " "
date:       2020-07-31 13:52:00
author:     "XiLock"
header-img: ""
header-mask: 0.3
catalog:    true
tags:
    - 《斤竹精舍·游艺集》
    - CS
    - 2020


---

**感谢嘉桢的技术指导**

### 问题描述
有时候希望实验室电脑能同时登陆内外网，内网控制实验室服务器，外网与其他计算机远程。同时连接内外网可通过有线和无线来实现，但有时会出现内外网的ip冲突而出现无法连接外网或者无法连接内网的情况，如外网连接不上向日葵等。  
为了解决这种问题，则需要手动修改一下路由器表。
### 方法
1. 查看内外网的ip地址段（网关），如xilock内网服务器（及其路由器）的网关为11.11.11.109（ip地址段为11.11.11.0-x），实验室外网路由器的网关为192.168.10.1，校园网的ip地址为172.23.55.178（xilock后面设定时选择网关为172.23.0.1）；
1. 用 `route print` 来查看路由器表；
1. 用 `route delete 0.0.0.0` 来删除所有的0.0.0.0的缺省路由（因为任意ip与0.0.0.0的网络遮罩做AND运算结果都是0.0.0.0，所以路由器表找不到传送路径的封包都会由预设路径传送）；
1. 接下来以有线连接内网，无线网卡连接外网为例；
1. 用 `route add 11.0.0.0 mask 255.0.0.0 11.11.11.109 -p`来设置内网的静态路由（即`route add 网络目标 mask 网络掩码 网关`，-p的意思是永久有效，防止重启电脑后配置的这条静态路由消失。）；
1. 用 `route add 0.0.0.0 mask 0.0.0.0 172.23.0.1 -p` 来设置外网静态路由，设置缺省路由的下一跳为172.23.0.1；
1. 用 `route print` 来检查配置完的路由器表。

使用实验室路由器连接外网配置：  
![](/attachment/computer/dinet_lab_route.png)  
1. 第一行，192.168.1.101为实验室路由器给PC分配的ip地址，当接收到一个数据包的目的网段不在路由记录中（需要走缺省路由时），该数据包通过 192.168.1.101这个接口发送到192.168.1.1这个地址，192.168.1.1是路由器的网关，也就是下一个路由器（学校的路由器）的一个接口，这样这个数据包就可以交付给下一个路由器处理。

使用tju连接外网配置：  
![](/attachment/computer/dinet_tju.png)
1. 第二行，11.168.1.100为内网路由器（连服务器的内网路由器）给PC分配的ip地址，当接收到在11.0.0.0网段的数据包时，该数据包通过11.168.1.100这个接口发送到11.11.11.109，11.11.11.109为内网路由器的网关，也是跟服务器连接的接口。

### 因路由器表变动而无法联网
有时路由器表会自动添加上一条将缺省路由链接到内网的记录，导致无法连接外网，使用下面的脚本可以定时查找这条记录并删除。  

delete_route_table.bat
```
@echo off

:start
route print | findstr 0.0.0.0 | findstr 11.11.11.109 >nul && route delete 0.0.0.0 mask 0.0.0.0 11.11.11.109

choice /t 300 /d y /n >nul
goto start
```


### 路由器连接
![](/attachment/computer/dinet_router_link.png)  
1. Cluster Router所控nodes的ip范围为11.11.11.1-9；
1. Router B不接WAN口且关闭DHCP，只利用其交换机功能；
1. 利用Router B的交换机功能对外网端口进行1分多，各端口均等效；
1. Router A的WAN端与Router B的LAN端连接后其WAN端即获取动态ip(如172.24.163.195)；
1. Router A的LAN端ip设置为11.11.11.109；
1. Router A和B连接后，Router A会将Router B的ip(如172.24.163.195)与Router A的ip(如11.11.11.109)进行强映射(绑定)；
1. 将Router A的LAN端分配ip与所连PC的mac地址绑定以防止PC的ip变化；
1. 绑定Router A与PC连接的端口的ip和port(如11.11.11.104和22或5900，22为ssh默认端口，5900为VNC默认端口)
1. 当某一PC处于外网同一局域网时，即可用VNC，通过Router A的WAN端ip(如172.24.163.195)控制Router A所接PC。


### WAN端接校园网-LAN端接局域网
1. LAN对LAN称为桥接网络。“网桥将两个原本相互独立的计算机网络连接起来，以实现它们之间的通信，并使它们可以作为一个网络工作。网桥与局域网一起使用，以将其范围扩展到覆盖局域网所不能达到的更大的物理区域。”
1. LAN到WAN称为网关网络。“网关是充当两个网络之间的“网关”的硬件设备。它可能是路由器，防火墙，服务器或其他使流量能够流入和流出网络的设备。而网关则保护其中的节点。网络，它本身也是一个节点。”

将路由器WAN端与墙上网线连接，然后将路由器LAN端与服务器及PC连接后，配置路由器LAN口ip（WAN口ip在接强之后会自动获取ip），之后路由器会自动将WAN口ip与LAN口ip匹配；    
![](/attachment/computer/dinet_router1.png)

对局域网进行ip分配，然后设置转发规则，将路由器的ip和端口与PC的ip和端口映射。路由器的端口是固定的（即服务端，如上图的11.11.11.109），所以路由器端只需要指定端口（随便指定，图中2000-2007只是为了好看，指定3000-3007也无妨）；PC端则需要指定ip地址和端口，ip地址用ipconfig查看即可，端口22是ssh/sftp的默认端口，5900则是vnc viewer的默认端口。  
![](/attachment/computer/dinet_router2.png)



### 参考
1. [如何设置双网卡电脑同时上内外网](https://jingyan.baidu.com/article/cbf0e500ac8b232eaa289339.html)
1. [router指令及解说](https://ocean2002n.pixnet.net/blog/post/85285946)

![](/img/wc-tail.GIF)